---
layout: post
title:  "TLS/SSL advancement, the privacy vs security dilemna"
summary: TLS/SSL advancement, the privacy vs security dilemna"
author: abde
date: '2024-02-26 14:35:23 +0530'
category: tech
thumbnail: /assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/TLS-and-ECH.png
keywords: CyberSec, TLS, ECH, Cloud
permalink: /blog/TLS_and_ECH
usemathjax: true
---

`TLS/SSL ESNI & ECH advancements, the privacy vs security dilemna`

## Introduction

In the evolving landscape of cybersecurity, recent years have seen significant
advancements in web encryption protocols, notably with the widespread adoption of
TLS 1.3, the introduction of Encrypted Server Name Indication (ESNI), the transition
from ESNI to Encrypted Client Hello (ECH), and the deployment of HTTP/3.

These technologies collectively mark a major shift in how user data is protected online,
but they also present specific challenges for network security monitoring and web-filtering.

> **Note**: In this document, we focus on the changes that directly impact network 
> security and filtering: SNI, CN, key-shares, ESNI/ECH DNS records, DoH, and how to 
> decrypt TLS.

---

## TLS1.2 vs TLS1.3 and Web-Filtering

### Web-Filtering in TLS 1.2

#### TLS 1.2 Exchange and Interesting Fields

TLS 1.2 (Transport Layer Security) provides secure communication but sends some
fields in cleartext:

- **SNI**: Server Name Indication  
- **CN**: Common Name in the server certificate  

Both can be inspected by network devices for filtering decisions.

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/TLS-11.2-with-DH.png" style="max-width: 400px;" alt="TLS 1.2 with DH exchange diagram">

Key points:

- Two round trips are needed before encryption fully starts.  
- The **SNI** and **CN** remain in cleartext, facilitating traditional filtering.

#### An inside look at TLS 1.2 packet capture

Below is an example where the **SNI** is visible in a typical TLS 1.2 exchange (cleartext):

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/TLS1.2-SNI-cleartext-wireshark.png" style="max-width: 400px;" alt="TLS 1.2 SNI in cleartext">

---

### TLS 1.3: A Leap Forward

#### TLS 1.3 Exchange and Interesting Changes

TLS 1.3 improves over TLS 1.2 by encrypting more data sooner and reducing round trips:

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/TLS1.3-exchange.png" style="max-width: 400px;" alt="TLS 1.3 Exchange Diagram">

- The client sends a keyshare immediately (ClientHello).  
- The server responds with its keyshare, allowing early encryption.  
- **CN** is generally protected sooner in TLS 1.3.  
- **SNI** remains in cleartext unless ESNI/ECH is used.  

---

## ESNI, ECH, and DoH: Securing the Last Leaks

### ESNI (Encrypted SNI)

ESNI was an early approach to encrypt just the SNI in the TLS 1.3 handshake. It introduced
a DNS record (`_esni`) allowing the client to fetch a public key to encrypt the SNI 
before sending the initial ClientHello. However, ESNI did not protect other fields (e.g., ALPN) 
and faced compatibility challenges. It has mostly been replaced by ECH.

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/TLS1.3-with-ESNI.png" style="max-width: 400px;" alt="TLS 1.3 with ESNI Extension">

### DoH (DNS over HTTPS)

A network observer could still learn the target domain from DNS queries, so DNS over
HTTPS (DoH) encrypts DNS requests as well. This is commonly configured in modern
browsers, further hiding the domain from on-path devices.

### Encrypted Client Hello (ECH)

ECH encrypts the entire ClientHello message, including SNI, ALPN, and other fields, 
offering a more complete privacy solution than ESNI. It relies on a new HTTPS record 
type (65) to fetch the server’s public key for encryption and typically operates alongside DoH.

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/ECH-exchange.png" style="max-width: 400px;" alt="ECH Exchange Diagram">

Key observations:

- Two ClientHellos (“outer” in cleartext vs. “inner” encrypted).  
- The “outer SNI” might be a CDN hostname, while the “inner SNI” is the real site.  
- Next-generation firewalls generally cannot see the true SNI without decryption.  

---

## QUIC and HTTP/3

HTTP/3 runs over QUIC, which also attempts to encrypt as much as possible. ECH can
apply to QUIC/HTTP/3 just like TLS 1.3, hiding the true SNI and other details from
on-path scanners.

---

## Raising Awareness and Future Perspectives

- **Machine Learning**: Some systems are testing ML-based traffic classification without relying solely on SNI.  
- **Man-in-the-Middle (MoM) Decryption**: Organizations may consider full TLS decryption for visibility, although this is more intrusive.  
- **Ongoing Refinements**: The ECH specification continues to evolve, so capabilities and defenses may shift rapidly.

Achieving both user privacy and necessary security visibility remains a balancing act.

---

## Annexe: Useful Information and Tools

### Pcaps / Keys Used in This Document

You will find the pcaps and TLS keys used in this document here:
[https://github.com/abdessamad-elamrani/New-TLS-and-Web-security-advancements](https://github.com/abdessamad-elamrani/New-TLS-and-Web-security-advancements)

<img src="{{site.baseurl}}/assets/img/posts/2024-05-05-TLS_1.3_esni_and_ECH_advancements/pcaps-github.png" style="max-width: 400px;" alt="PCAPs GitHub repository screenshot">

### How to Decrypt TLS

1. **Obtain Session Keys**: Set an environment variable, for example:

export SSLKEYLOGFILE=/path/to/sslkeys.txt

Then configure Wireshark (Preferences → Protocols → TLS → (Pre)-Master-Secret log filename).  

2. **Capture Traffic**: Perform a packet capture with the client that has session logging enabled.  

3. **Load Keys**: Open Wireshark, specify the log file, and the capture will be decrypted if the session keys match.  

This approach works for both TLS 1.2 and TLS 1.3, though some limitations may apply to early data or advanced mechanisms.